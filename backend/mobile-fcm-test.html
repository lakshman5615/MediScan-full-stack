<!DOCTYPE html>
<html>
<head>
    <title>MediScan Mobile FCM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        button { width: 100%; padding: 15px; margin: 10px 0; font-size: 16px; }
        .token { word-break: break-all; background: #f5f5f5; padding: 10px; }
        .notification { background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± MediScan Mobile FCM</h1>
        
        <button onclick="requestPermission()">üîî Enable Notifications</button>
        <button onclick="generateToken()">üîë Generate FCM Token</button>
        <button onclick="sendTokenToBackend()">üì§ Send to Backend</button>
        <button onclick="testNotification()">üß™ Test Notification</button>
        
        <div id="status"></div>
        <div id="token" class="token"></div>
        <div id="notifications"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
        import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging.js';

        // Firebase config for mediscan-notifications
        const firebaseConfig = {
            apiKey: "AIzaSyBvOh7CsKp8F5RjRqNzQzv4o4fZ2Y8nQ1A",
            authDomain: "mediscan-notifications.firebaseapp.com",
            projectId: "mediscan-notifications",
            storageBucket: "mediscan-notifications.appspot.com",
            messagingSenderId: "1094554203665",
            appId: "1:1094554203665:web:abc123def456"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
        
        let currentToken = '';
        let jwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InNodWJoYW1AdGVzdC5jb20iLCJfaWQiOiI2OTcyMjhhMGJiYWIzZWFlYjFhOWM2ZjYiLCJpYXQiOjE3NjkwOTEzMDEsImV4cCI6MTc2OTY5NjEwMX0.zl_BGe9gmaErX2hM0U3-EZcGcro-anZjlJQDSq5FiJk';

        // Request notification permission
        window.requestPermission = async function() {
            try {
                const permission = await Notification.requestPermission();
                document.getElementById('status').innerHTML = `
                    <div class="notification">
                        üîî Permission: ${permission}
                        ${permission === 'granted' ? '‚úÖ Notifications enabled!' : '‚ùå Please enable notifications'}
                    </div>
                `;
            } catch (error) {
                console.error('Permission error:', error);
            }
        }

        // Generate FCM token
        window.generateToken = async function() {
            try {
                const token = await getToken(messaging, {
                    vapidKey: 'BCDVAB6Kcn6GyveyDK3XmHbwmkEDmqBhQkl8ko0m14Lh7UxgYOd2hwQJB-bao-JqSYR9q6d5h3sboXkywL--QMA'
                });
                
                currentToken = token;
                document.getElementById('token').innerHTML = `
                    <h3>üîë Your FCM Token:</h3>
                    <textarea rows="4" style="width:100%">${token}</textarea>
                    <button onclick="copyToken()">üìã Copy Token</button>
                `;
                
                console.log('FCM Token:', token);
            } catch (error) {
                console.error('Token error:', error);
                document.getElementById('token').innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // Send token to backend
        window.sendTokenToBackend = async function() {
            if (!currentToken) {
                alert('Please generate token first!');
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/auth/fcm-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({ fcmToken: currentToken })
                });

                const result = await response.json();
                document.getElementById('status').innerHTML = `
                    <div class="notification">
                        üì§ Token sent to backend: ${result.message || 'Success!'}
                    </div>
                `;
            } catch (error) {
                console.error('Backend error:', error);
            }
        }

        // Test notification
        window.testNotification = async function() {
            try {
                const response = await fetch('http://localhost:5000/api/medicine/notify-phone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({
                        phoneNumber: '9111393409',
                        title: 'üîî Mobile FCM Test',
                        message: 'Shubham ko mobile notification mil gaya! Free FCM working! üì±üéâ'
                    })
                });

                const result = await response.json();
                console.log('Test result:', result);
            } catch (error) {
                console.error('Test error:', error);
            }
        }

        // Copy token to clipboard
        window.copyToken = function() {
            navigator.clipboard.writeText(currentToken);
            alert('Token copied to clipboard!');
        }

        // Listen for incoming messages
        onMessage(messaging, (payload) => {
            console.log('Message received:', payload);
            
            document.getElementById('notifications').innerHTML += `
                <div class="notification">
                    <strong>üì± ${payload.notification.title}</strong><br>
                    ${payload.notification.body}<br>
                    <small>${new Date().toLocaleString()}</small>
                </div>
            `;

            // Show browser notification
            if (Notification.permission === 'granted') {
                new Notification(payload.notification.title, {
                    body: payload.notification.body,
                    icon: 'üì±'
                });
            }
        });

        // Auto-request permission on load
        window.addEventListener('load', () => {
            window.requestPermission();
        });
    </script>
</body>
</html>